<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<title>Visor Territorial Prueba</title>

<!------------------------STYLES------------------------>
    
<!-----------------------FRAMEWORKS Y COMPLEMENTOS------------------------>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
<script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<link rel="stylesheet" href="assets/css/leaflet.zoomhome.css" />
<link rel="stylesheet" href="assets/css/L.Control.Locate.scss" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<script src="assets/js/L.Control.Locate.js"></script>
<script src="assets/js/leaflet.zoomhome.js"></script>
<script src="assets/js/leaflet-hash.js"></script>
<script src="assets/js/leaflet.rotatedMarker.js"></script>
<script src="assets/js/wNumb.js"></script>
<script src="assets/js/labelgun.min.js"></script>
<link rel="stylesheet" href="assets/css/index1.css" />
<script src="assets/js/index1.js"></script>
<link rel="stylesheet" href="assets/css/leaflet-search.css" />
<script src="assets/js/leaflet-search.js"></script>
<!--FAVICON-->
<link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
<link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!----------------------------CAPAS-GEOJSON----------------------------->
<script type="text/javascript" src="data/limite_comunal.js"></script>
<script type="text/javascript" src="data/comunidades2022.js"></script>
<script type="text/javascript" src="data/loc2022.js"></script>

<script src="assets/js/leaflet.groupedlayercontrol.min.js"></script>
<!-- <link rel="stylesheet" href="assets/css/leaflet.groupedlayercontrol.min.css" /> -->

<style>
/*TÍTULO RESPONSIVE*/
@media(max-width: 450px){
    .navbar-brand{
    font-size: 4vw;
  }
    #logo{
      width: 35px;
      height: 35px;

    }  
  }

.fa-spin{
  color: orange;
}

.fa-location-arrow {
  vertical-align: middle;
  margin-top: -2px;
  color: orange;
};

.img {
  vertical-align: middle;
}


</style>

</head>

<body>
<!--NAVBAR-->
<nav class="navbar navbar-expand-md navbar-light fixed-top lex-sm-nowrap flex-wrap" aria-label="Fourth navbar example" id="navBar1">
    <div class="container-fluid col-lg-10 col-xl-10">
          <a class="navbar-brand" style="margin:0px;"><b>COMUNIDADES Y LOCALIDADES</b></a>
      <div style="padding-left: 4px; padding-right: 8px; justify-content: center;">
          <img id="logo" src="img/logo_muni2.png" height="50px" width="50px" style="margin-left: 0px; margin-right: 0px;">
      </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
          </button>
    <div class="collapse navbar-collapse" id="navbarsExample04" style="margin-left:0px;">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
          <a class="nav-link" href="http://www.nuevaimperial.cl" target="_blank" aria-current="page" ref="#">Web Municipalidad</a>
          </li>
          <li class="nav-item">
          <a class="nav-link" href="#aboutPage" data-bs-toggle="modal" data-target="#aboutPage">Acerca de</a>
          </li>
        <li class="nav-item dropdown" id="despliega">
          <a class="nav-link dropdown-toggle" href="#" id="dropdown04" data-bs-toggle="dropdown" aria-expanded="false">Descargas</a>
          <ul class="dropdown-menu" aria-labelledby="dropdown04" style="margin-top:-10px">
            <li><a class="dropdown-item" href="#">Descargar PDF</a></li>
            <li><a class="dropdown-item" href="#">Descargar KML</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown" id="despliega">
          <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-bs-toggle="dropdown" aria-expanded="false">Información territorial</a>
          <ul class="dropdown-menu" aria-labelledby="dropdown04" style="margin-top:-10px">
            <li><a class="dropdown-item" href="#" id="full-extent-btn">Plan regulador comunal</a></li>
            <li><a class="dropdown-item" href="#">Áreas verdes</a></li>
          </ul>
        </li>  
        </ul>
      </div>
    </div>
  </nav>
<!--MAP-->
  <div id="map">
  </div>
<!--MODAL ABOUT (PENDIENTE: CENTRAR CONTENIDO EN EL MODAL)-->
<div class="modal" tabindex="" id="aboutPage">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Información acerca del departamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">  
        <div class="container-fluid">
          <div class="row">
            <div class="lg-12">
              <div class="center-block">
              <p>Utilización del visor, información de interés, etc.</p>
              <p><img src="assets/css/images/logo_muni2.png"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<script>

// MODAL
var aboutPage = document.getElementById('aboutPage')
var myInput = document.getElementById('myInput')

aboutPage.addEventListener('shown.bs.modal', function () {
});


// MAPA BASE
 var map = L.map('map', {zoomControl: false, minZoom: 10, maxZoom: 15, zoomSnap: 0.5}).setView([-38.6959326, -72.98552], 10.5);
 
 var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    opacity: 1.0,
    minZoom: 10,
    maxZoom: 15,
    minNativeZoom: 0,
    maxNativeZoom: 18,
    zIndex: 400,
}).addTo(map);

var ESRIsat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '©<a href="http://www.esri.com/"> Esri</a>',
    opacity: 1.0,
    minZoom: 10,
    maxZoom: 15,
    minNativeZoom: 0,
    maxNativeZoom: 18,
    zIndex: 399,
});



// ZOOM CONTROL

L.control.zoom({
zoomInTitle: 'Acercar',
zoomOutTitle: 'Alejar'
}).addTo(map);
;

L.Control.zoomHome();

// UBICACIÓN
L.control.locate({
position: 'topleft',
icon: 'fa fa-location-arrow fa-2x',
iconLoading: 'fa fa-spinner fa-spin fa-lg',
flyTo: true,
locateOptions: {
  enableHighAccuracy: true
},
strings: {
title: "Muestra tu ubicación actual",
popup: "La precisión actual es de aprox. {distance} {unit} alrededor de este punto.",
metersUnit: "metros",
    }
}).addTo(map);

/*INFO RECUADRO

var info = L.control();

info.onAdd = function (map) {
  this._div = L.DomUtil.create('div', 'info');
  this.update();
  return this._div;
};

info.update = function (props) {
  this._div.innerHTML = '<h4>Localidad/comunidad</h4>' +  (props ?
    '<b>' + props.COMUNIDAD + '</b><br/>' : 'Seleccione para ver información');
};
info.addTo(map);
*/

// PROPIEDADES HOVER TM

function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
      weight: 4,
        dashArray: '',
        fillOpacity: 0.7
    });

  }

function resetHighlightTM(e) {
  tmImpe.resetStyle(e.target);
}

// onEach TM

function onEachFeatureTM(feature, layer) {    
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlightTM,
  });

  var popupContent =  '<table class="">\
                      <tr>\
                        <th scope="row">Comunidad:</th>\
                        <td>' + '&nbsp' + (feature.properties.NOMBRE) + '</td>\
                      </tr>\
                      <tr>\
                        <th scope="row">Lugar/sector:</th>\
                        <td>' + '&nbsp' + (feature.properties.LUGAR) + '</td>\
                      </tr>\
                      </table>\
                      '
                      ;
  layer.bindPopup(popupContent,{
    maxHeight: 400,
  });
}

// onEach Loc

function onEachFeatureLoc(feature, layer) {    
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlightLoc,
  });

  var popupContent =  '<table class="">\
                      <tr>\
                        <th "scope="row">Localidad:</th>\
                        <td>' + '&nbsp' + (feature.properties.NOMBRE) + '</td>\
                      </tr>\
                      </table>\
                      '
                      ;
  layer.bindPopup(popupContent,{
    maxHeight: 400,
  });
}

function resetHighlightLoc(e) {
  locImpe.resetStyle(e.target);
}

/* SEGUNDA PARTE DE LA TABLA
<tr>\
                        <th scope="row">TM:</th>\
                        <td>' + '&nbsp' + (feature.properties.TM) + '</td>\
                      </tr>\
                      </table>\
                      <hr>Este espacio se puede utilizar para cualquier descripción, atributo, etc.'
*/


//Función de estilo para limitecomunal
function styleLimite(feature) {
  return{
    fillOpacity:0,
    opacity: 0.8,
    color: 'rgba(219,58,58, 1.0)',
    //dashArray: '10,5', (Línea punteada, mayor valor menos segmentos)
    lineCap: 'butt',  
    lineJoin: 'round',  //(Uniones, redondeadas o rectas)
    weight: 2.0,
    fill: false,
    fillOpacity: 0.8,
    fillColor: 'rgba(229,182,54,0.0)',
    interactive: false,
  }
}

//Función de estilo para TM
function styleTM(feature) {
  return{
    fillOpacity:0,
    opacity: 0.2,
    color: 'rgba(34,24,24,1.0)',
    //dashArray: '10,5', (Línea punteada, mayor valor menos segmentos)
    lineCap: 'butt',  
    lineJoin: 'round',  //(Uniones, redondeadas o rectas)
    weight: 0.6,
    fill: true,
    fillOpacity: 0.3,
    fillColor: '#f5f225',
    interactive: true,
  }
}

//Función de estilo para Loc
function styleLoc(feature) {
  return{
    fillOpacity: 0,
    opacity: 0.2,
    color: 'rgba(34,24,24,1.0)',
    //dashArray: '10,5', (Línea punteada, mayor valor menos segmentos)
    lineCap: 'butt',  
    lineJoin: 'round',  //(Uniones, redondeadas o rectas)
    weight: 0.6,
    fill: true,
    fillOpacity: 0.3,
    fillColor: '#f58925', 
    interactive: true,
  }
}

//CAPAS

var imp = L.geoJson(limiteComunal, {
  style: styleLimite,
}).addTo(map);

var tmImpe = new L.geoJson(com2022, {
  style: styleTM,
  onEachFeature: onEachFeatureTM,       // onEach (hover, popup) 
}).addTo(map);

var locImpe = new L.geoJson(locImperial, {
  style: styleLoc,
  onEachFeature: onEachFeatureLoc,
}).addTo(map);


var baselayers = {
  "Mapa base - Open Street Maps": osm,
  "Mapa base - ESRI Satelital": ESRIsat,
}

var locTM = {
  "CAPAS DE INFORMACIÓN": {
    '<img style="margin-bottom:4px; margin-right:4px; box-shadow:2px 2px 2px gray" src="legend/tmImp.png" /> Comunidades': tmImpe,
    '<img style="margin-bottom:5px; margin-right:4px; box-shadow:2px 2px 2px gray" src="legend/locRural.png" /> Localidades rurales': locImpe
 }
};

L.control.groupedLayers(baselayers, locTM).addTo(map);


// BUSQUEDA

var searchLayers = L.layerGroup([
  tmImpe,
   locImpe
  ]);


var searchControl = new L.Control.Search({
		layer: searchLayers, 
		propertyName: 'NOMBRE',
    initial: false,
		marker: false,
    buildTip: function(text, val) {
			var type = val.layer.feature.properties.TIPO;
			return '<a href="#" class="'+type+'">'+text+'<b>'+type+'</b></a>';
		},
    zoom: 12,
    textPlaceholder: 'Buscar localidad/comunidad',
    textCancel: 'Cancelar',
    textErr: 'No encontrado',
    marker: {
      icon: 'fa fa-map-marker',
    },
	});
	
  searchControl.on('search:locationfound', function(e) {
		e.layer.setStyle({fillColor: '#25c5f5', color: '#25c5f5', opacity: 0.8});
		if(e.layer._popup)
			e.layer.openPopup();
	}).on('search:collapsed', function(e) {
		featuresLayer.eachLayer(function(layer) {	// restaurar color entidad
      featuresLayer.resetStyle(layer);
		});	
	});
	
  map.addControl(searchControl);



</script>
<!--SELECTOR DE COLOR-->
<style>
  /*
  .fill{
    background-color: #f5e725, rgb(rgb(34, 24, 24));
  }
  */
</style>


</body>
</html>